<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>MININA - Dashboard v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%); }
        .glass-panel { background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.15); }
        .sidebar-item { transition: all 0.3s ease; }
        .sidebar-item:hover { background: rgba(255, 255, 255, 0.15); transform: translateX(-5px); }
        .sidebar-item.active { background: linear-gradient(90deg, rgba(147, 197, 253, 0.3), transparent); border-left: 4px solid #60a5fa; }
        .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); transition: all 0.3s ease; }
        .btn-primary:hover { transform: scale(1.02); box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4); }
        .btn-danger { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .input-field { background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.2); transition: all 0.3s ease; }
        .input-field:focus { border-color: #60a5fa; box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2); }
        .section-hidden { display: none; }
        .section-visible { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .cat-logo { animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        .step-card { border-left: 4px solid #60a5fa; }
        .status-badge { display: inline-flex; align-items: center; padding: 4px 12px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .status-connected { background: rgba(34, 197, 94, 0.2); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); }
        .status-disconnected { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 40; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .menu-overlay.active { opacity: 1; visibility: visible; }
        .toast { animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white overflow-x-hidden">
    <div id="menuOverlay" class="menu-overlay lg:hidden" onclick="toggleMenu()"></div>
    
    <!-- Header con Logo de Gato -->
    <nav class="glass-panel sticky top-0 z-50 px-6 py-4">
        <div class="flex items-center justify-between max-w-7xl mx-auto">
            <div class="flex items-center space-x-4">
                <!-- Cat Logo -->
                <div class="cat-logo w-14 h-14 bg-gradient-to-br from-cyan-400 via-blue-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg rotate-3">
                    <svg viewBox="0 0 24 24" class="w-9 h-9 text-white" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                        <circle cx="9" cy="10" r="1.5" fill="white"/>
                        <circle cx="15" cy="10" r="1.5" fill="white"/>
                        <path d="M12 13c-1.66 0-3 1.34-3 3h6c0-1.66-1.34-3-3-3z" fill="white" opacity="0.8"/>
                        <path d="M4 8l2-2m12 2l-2-2" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold tracking-tight bg-gradient-to-r from-white to-gray-300 bg-clip-text">MININA</h1>
                    <p class="text-xs text-cyan-300"> Asistente Virtual con Memoria</p>
                </div>
            </div>
            
            <div class="flex items-center space-x-4">
                <div class="hidden md:flex items-center space-x-2 px-4 py-2 glass-panel rounded-full">
                    <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                    <span class="text-sm text-gray-200">Sistema Online</span>
                </div>
                <button onclick="toggleMenu()" class="lg:hidden p-2 glass-panel rounded-lg hover:bg-white/20 transition">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="flex max-w-7xl mx-auto">
        <!-- Main Content -->
        <main class="flex-1 p-6 lg:mr-80">
            
            <!-- DASHBOARD -->
            <div id="dashboardSection" class="section-visible">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="glass-panel rounded-2xl p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-xl flex items-center justify-center">
                                <i class="fas fa-cubes text-xl"></i>
                            </div>
                            <span class="text-3xl font-bold" id="skillsCount">-</span>
                        </div>
                        <p class="text-gray-300 text-sm">Skills Instaladas</p>
                    </div>
                    <div class="glass-panel rounded-2xl p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-green-400 to-emerald-500 rounded-xl flex items-center justify-center">
                                <i class="fas fa-play-circle text-xl"></i>
                            </div>
                            <span class="text-3xl font-bold" id="activeAgents">-</span>
                        </div>
                        <p class="text-gray-300 text-sm">Agentes Activos</p>
                    </div>
                    <div class="glass-panel rounded-2xl p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-purple-400 to-pink-500 rounded-xl flex items-center justify-center">
                                <i class="fas fa-brain text-xl"></i>
                            </div>
                            <span class="text-3xl font-bold" id="memoryCount">-</span>
                        </div>
                        <p class="text-gray-300 text-sm">Memorias LTM</p>
                    </div>
                    <div class="glass-panel rounded-2xl p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-xl flex items-center justify-center">
                                <i class="fas fa-microchip text-xl"></i>
                            </div>
                            <span class="text-lg font-bold" id="llmStatus">-</span>
                        </div>
                        <p class="text-gray-300 text-sm">LLM Status</p>
                    </div>
                </div>

                <!-- Chat -->
                <div class="glass-panel rounded-2xl p-6 mb-6 flex flex-col" style="height: 500px;">
                    <div class="flex items-center justify-between mb-4 flex-shrink-0">
                        <h2 class="text-xl font-bold flex items-center">
                            <i class="fas fa-comments mr-3 text-cyan-400"></i>Chat con Memoria
                        </h2>
                        <!-- API Selector for Chat -->
                        <select id="chatApiSelector" class="px-3 py-1 bg-white/10 rounded-lg text-sm text-white border border-white/20">
                            <option value="gemini">Gemini</option>
                            <option value="openai">OpenAI</option>
                            <option value="groq" selected>Groq</option>
                            <option value="ollama">Ollama</option>
                            <option value="grok">Grok</option>
                        </select>
                    </div>
                    <div id="chatMessages" class="flex-1 overflow-y-auto mb-4 space-y-3 p-4 bg-black/20 rounded-xl" style="scroll-behavior: smooth;">
                        <div class="text-center py-8 text-gray-400">
                            <i class="fas fa-robot text-4xl mb-2 text-cyan-400"></i>
                            <p>隆Hola! Soy MININA con sistema de memoria.</p>
                            <p class="text-sm mt-2">Prueba: "recuerda que me gusta Python"</p>
                        </div>
                    </div>
                    <div class="flex space-x-3 flex-shrink-0">
                        <input type="text" id="chatInput" class="flex-1 px-4 py-3 input-field rounded-xl text-white placeholder-gray-400 focus:outline-none" placeholder="Escribe un mensaje...">
                        <button onclick="sendMessage()" class="btn-primary px-6 py-3 rounded-xl font-semibold">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- TELEGRAM INTEGRATION -->
            <div id="telegramSection" class="section-hidden">
                <div class="glass-panel rounded-2xl p-8 mb-6">
                    <div class="flex items-center mb-6">
                        <div class="w-16 h-16 bg-gradient-to-br from-blue-400 to-blue-600 rounded-2xl flex items-center justify-center mr-4 shadow-lg">
                            <i class="fab fa-telegram text-3xl"></i>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold">Integraci贸n Telegram</h2>
                            <span id="telegramStatusBadge" class="status-badge status-disconnected">
                                <span class="w-2 h-2 rounded-full bg-current mr-2"></span>Desconectado
                            </span>
                        </div>
                    </div>

                    <!-- Instructions -->
                    <div class="space-y-4 mb-8">
                        <h3 class="text-lg font-semibold text-cyan-400 mb-4"> Gu铆a de Configuraci贸n</h3>
                        
                        <div class="step-card glass-panel p-4 rounded-xl">
                            <div class="flex items-start">
                                <span class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-sm font-bold mr-4">1</span>
                                <div>
                                    <h4 class="font-semibold mb-1">Crear un Bot en Telegram</h4>
                                    <p class="text-sm text-gray-300 mb-2">Abre Telegram y busca <strong>@BotFather</strong></p>
                                    <a href="https://t.me/BotFather" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm">
                                        <i class="fas fa-external-link-alt mr-1"></i>Abrir BotFather
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div class="step-card glass-panel p-4 rounded-xl">
                            <div class="flex items-start">
                                <span class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-sm font-bold mr-4">2</span>
                                <div>
                                    <h4 class="font-semibold mb-1">Enviar comando /newbot</h4>
                                    <p class="text-sm text-gray-300">BotFather te pedir谩 un nombre y username para tu bot</p>
                                </div>
                            </div>
                        </div>

                        <div class="step-card glass-panel p-4 rounded-xl">
                            <div class="flex items-start">
                                <span class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-sm font-bold mr-4">3</span>
                                <div>
                                    <h4 class="font-semibold mb-1">Obtener el Token</h4>
                                    <p class="text-sm text-gray-300 mb-2">BotFather te dar谩 un token como:</p>
                                    <code class="bg-black/30 px-2 py-1 rounded text-xs">123456789:ABCdefGHIjklMNOpqrSTUvwxyz</code>
                                </div>
                            </div>
                        </div>

                        <div class="step-card glass-panel p-4 rounded-xl">
                            <div class="flex items-start">
                                <span class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-sm font-bold mr-4">4</span>
                                <div>
                                    <h4 class="font-semibold mb-1">Obtener tu Chat ID</h4>
                                    <p class="text-sm text-gray-300 mb-2">Busca <strong>@userinfobot</strong> en Telegram</p>
                                    <a href="https://t.me/userinfobot" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm">
                                        <i class="fas fa-external-link-alt mr-1"></i>Abrir UserInfoBot
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Secure Form -->
                    <div class="glass-panel p-6 rounded-xl border border-blue-500/30">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-shield-alt text-green-400 mr-2"></i>Configuraci贸n Segura
                        </h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Nombre del Bot</label>
                                <input type="text" id="telegramBotName" class="w-full px-4 py-3 input-field rounded-xl text-white placeholder-gray-400" placeholder="Ej: MiBotMININA">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Bot Token <span class="text-red-400">*</span></label>
                                <div class="relative">
                                    <input type="password" id="telegramToken" class="w-full px-4 py-3 input-field rounded-xl text-white placeholder-gray-400 pr-12" placeholder="Ingresa el token de BotFather">
                                    <button onclick="toggleVisibility('telegramToken')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <p class="text-xs text-gray-400 mt-1"><i class="fas fa-lock mr-1"></i>Este token est谩 encriptado y solo t煤 puedes verlo</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Chat ID <span class="text-red-400">*</span></label>
                                <input type="text" id="telegramChatId" class="w-full px-4 py-3 input-field rounded-xl text-white placeholder-gray-400" placeholder="Ej: 123456789">
                            </div>
                            
                            <div class="flex space-x-3 pt-4">
                                <button onclick="saveTelegram()" class="btn-primary flex-1 py-3 rounded-xl font-semibold">
                                    <i class="fas fa-save mr-2"></i>Guardar y Conectar
                                </button>
                                <button onclick="deleteTelegram()" class="btn-danger px-4 py-3 rounded-xl font-semibold">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WHATSAPP INTEGRATION -->
            <div id="whatsappSection" class="section-hidden">
                <div class="glass-panel rounded-2xl p-8 mb-6">
                    <div class="flex items-center mb-6">
                        <div class="w-16 h-16 bg-gradient-to-br from-green-400 to-green-600 rounded-2xl flex items-center justify-center mr-4 shadow-lg">
                            <i class="fab fa-whatsapp text-3xl"></i>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold">Integraci贸n WhatsApp</h2>
                            <span id="whatsappStatusBadge" class="status-badge status-disconnected">
                                <span class="w-2 h-2 rounded-full bg-current mr-2"></span>Desconectado
                            </span>
                        </div>
                    </div>

                    <!-- Instructions -->
                    <div class="space-y-4 mb-8">
                        <h3 class="text-lg font-semibold text-green-400 mb-4"> Gu铆a de Configuraci贸n</h3>
                        
                        <div class="step-card glass-panel p-4 rounded-xl border-l-green-400">
                            <div class="flex items-start">
                                <span class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-sm font-bold mr-4">1</span>
                                <div>
                                    <h4 class="font-semibold mb-1">Crear cuenta en Twilio</h4>
                                    <p class="text-sm text-gray-300 mb-2">WhatsApp Business API requiere Twilio</p>
                                    <a href="https://www.twilio.com/try-twilio" target="_blank" class="text-green-400 hover:text-green-300 text-sm">
                                        <i class="fas fa-external-link-alt mr-1"></i>Crear cuenta Twilio
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div class="step-card glass-panel p-4 rounded-xl border-l-green-400">
                            <div class="flex items-start">
                                <span class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-sm font-bold mr-4">2</span>
                                <div>
                                    <h4 class="font-semibold mb-1">Activar WhatsApp Sandbox</h4>
                                    <p class="text-sm text-gray-300">En Twilio Console > Messaging > Try it out > Send a WhatsApp message</p>
                                </div>
                            </div>
                        </div>

                        <div class="step-card glass-panel p-4 rounded-xl border-l-green-400">
                            <div class="flex items-start">
                                <span class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-sm font-bold mr-4">3</span>
                                <div>
                                    <h4 class="font-semibold mb-1">Obtener Account SID y Auth Token</h4>
                                    <p class="text-sm text-gray-300 mb-2">En Twilio Console Dashboard:</p>
                                    <code class="bg-black/30 px-2 py-1 rounded text-xs block mb-1">ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</code>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Secure Form -->
                    <div class="glass-panel p-6 rounded-xl border border-green-500/30">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-shield-alt text-green-400 mr-2"></i>Configuraci贸n Segura
                        </h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Account SID <span class="text-red-400">*</span></label>
                                <div class="relative">
                                    <input type="password" id="waAccountSid" class="w-full px-4 py-3 input-field rounded-xl text-white placeholder-gray-400 pr-12" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                                    <button onclick="toggleVisibility('waAccountSid')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Auth Token <span class="text-red-400">*</span></label>
                                <div class="relative">
                                    <input type="password" id="waAuthToken" class="w-full px-4 py-3 input-field rounded-xl text-white placeholder-gray-400 pr-12" placeholder="Tu Auth Token de Twilio">
                                    <button onclick="toggleVisibility('waAuthToken')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <p class="text-xs text-gray-400 mt-1"><i class="fas fa-lock mr-1"></i>Este token est谩 encriptado y solo t煤 puedes verlo</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Tu N煤mero WhatsApp <span class="text-red-400">*</span></label>
                                <input type="text" id="waToNumber" class="w-full px-4 py-3 input-field rounded-xl text-white placeholder-gray-400" placeholder="+1234567890">
                                <p class="text-xs text-gray-400 mt-1">Con c贸digo de pa铆s (ej: +52 para M茅xico)</p>
                            </div>
                            
                            <div class="flex space-x-3 pt-4">
                                <button onclick="saveWhatsApp()" class="btn-primary flex-1 py-3 rounded-xl font-semibold bg-gradient-to-r from-green-500 to-emerald-600">
                                    <i class="fas fa-save mr-2"></i>Guardar y Conectar
                                </button>
                                <button onclick="deleteWhatsApp()" class="btn-danger px-4 py-3 rounded-xl font-semibold">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- APIS KEYS SECTION -->
            <div id="apisSection" class="section-hidden">
                <div class="glass-panel rounded-2xl p-6 mb-6">
                    <div class="flex items-center mb-6">
                        <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-600 rounded-2xl flex items-center justify-center mr-4 shadow-lg">
                            <i class="fas fa-key text-3xl"></i>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold">API Keys</h2>
                            <p class="text-sm text-gray-300">Configura tus proveedores de IA</p>
                        </div>
                    </div>

                    <!-- API Provider Tabs -->
                    <div class="flex flex-wrap gap-2 mb-6">
                        <button onclick="showApiProvider('gemini')" id="tab-gemini" class="api-tab active px-4 py-2 rounded-lg bg-gradient-to-r from-blue-500 to-blue-600 font-medium">
                            <i class="fas fa-brain mr-2"></i>Gemini
                        </button>
                        <button onclick="showApiProvider('openai')" id="tab-openai" class="api-tab px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition">
                            <i class="fab fa-openai mr-2"></i>OpenAI
                        </button>
                        <button onclick="showApiProvider('grok')" id="tab-grok" class="api-tab px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition">
                            <i class="fas fa-robot mr-2"></i>Grok
                        </button>
                        <button onclick="showApiProvider('meta')" id="tab-meta" class="api-tab px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition">
                            <i class="fab fa-meta mr-2"></i>Meta
                        </button>
                        <button onclick="showApiProvider('ollama')" id="tab-ollama" class="api-tab px-4 py-2 rounded-lg bg-gradient-to-r from-green-500 to-emerald-600 font-medium">
                            <i class="fas fa-server mr-2"></i>Ollama 
                        </button>
                        <button onclick="showApiProvider('groq')" id="tab-groq" class="api-tab px-4 py-2 rounded-lg bg-gradient-to-r from-orange-500 to-red-600 font-medium">
                            <i class="fas fa-bolt mr-2"></i>Groq 
                        </button>
                        <button onclick="showApiProvider('gemma')" id="tab-gemma" class="api-tab px-4 py-2 rounded-lg bg-gradient-to-r from-purple-500 to-indigo-600 font-medium">
                            <i class="fas fa-gem mr-2"></i>Gemma 
                        </button>
                    </div>

                    <!-- GEMINI -->
                    <div id="api-gemini" class="api-content">
                        <div class="glass-panel p-6 rounded-xl border border-blue-500/30 mb-6">
                            <h3 class="text-lg font-semibold text-blue-400 mb-4"> C贸mo obtener API Key de Google Gemini</h3>
                            <div class="space-y-3 text-sm text-gray-300">
                                <div class="step-card glass-panel p-3 rounded-lg">
                                    <p><strong>1.</strong> Ve a <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-blue-400">Google AI Studio</a></p>
                                </div>
                                <div class="step-card glass-panel p-3 rounded-lg">
                                    <p><strong>2.</strong> Inicia sesi贸n con tu cuenta de Google</p>
                                </div>
                                <div class="step-card glass-panel p-3 rounded-lg">
                                    <p><strong>3.</strong> Haz clic en "Get API key" o "Crear API key"</p>
                                </div>
                                <div class="step-card glass-panel p-3 rounded-lg">
                                    <p><strong>4.</strong> Copia la clave generada (empieza con <code>AIza...</code>)</p>
                                </div>
                            </div>
                        </div>
                        <div class="glass-panel p-6 rounded-xl border border-blue-500/30">
                            <h3 class="text-lg font-semibold mb-4 flex items-center">
                                <i class="fas fa-shield-alt text-green-400 mr-2"></i>Configuraci贸n Segura
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">API Key Gemini <span class="text-red-400">*</span></label>
                                    <div class="relative">
                                        <input type="password" id="apiKeyGemini" class="w-full px-4 py-3 input-field rounded-xl text-white placeholder-gray-400 pr-12" placeholder="AIza...">
                                        <button onclick="toggleVisibility('apiKeyGemini')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-400 mt-1"><i class="fas fa-lock mr-1"></i>Solo t煤 puedes ver esta clave</p>
                                </div>
                                <div class="flex space-x-3">
                                    <button onclick="saveApiKey('gemini')" class="btn-primary flex-1 py-3 rounded-xl font-semibold">
                                        <i class="fas fa-save mr-2"></i>Guardar API Key
                                    </button>
                                    <button onclick="deleteApiKey('gemini')" class="btn-danger px-4 py-3 rounded-xl font-semibold">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- OPENAI -->
                    <div id="api-openai" class="api-content hidden">
                        <div class="glass-panel p-6 rounded-xl border border-green-500/30 mb-6">
                            <h3 class="text-lg font-semibold text-green-400 mb-4"> C贸mo obtener API Key de OpenAI</h3>
                            <div class="space-y-3 text-sm text-gray-300">
                                <div class="step-card glass-panel p-3 rounded-lg">
                                    <p><strong>1.</strong> Ve a <a href="https://platform.openai.com/api-keys" target="_blank" class="text-green-400">OpenAI Platform</a></p>
                                </div>
                                <div class="step-card glass-panel p-3 rounded-lg">
                                    <p><strong>2.</strong> Inicia sesi贸n o crea una cuenta</p>
                                </div>
                                <div class="step-card glass-panel p-3 rounded-lg">
                                    <p><strong>3.</strong> Ve a "API Keys" y haz clic en "Create new secret key"</p>
                                </div>
                                <div class="step-card glass-panel p-3 rounded-lg">
                                    <p><strong>4.</strong> Copia la clave (empieza con <code>sk-...</code>) - 隆solo se muestra una vez!</p>
                                </div>
                            </div>
                        </div>
                        <div class="glass-panel p-6 rounded-xl border border-green-500/30">
                            <h3 class="text-lg font-semibold mb-4 flex items-center">
                                <i class="fas fa-shield-alt text-green-400 mr-2"></i>Configuraci贸n Segura
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">API Key OpenAI <span class="text-red-400">*</span></label>
                                    <div class="relative">
                                        <input type="password" id="apiKeyOpenAI" class="w-full px-4 py-3 input-field rounded-xl text-white placeholder-gray-400 pr-12" placeholder="sk-...">
                                        <button onclick="toggleVisibility('apiKeyOpenAI')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-400 mt-1"><i class="fas fa-lock mr-1"></i>Solo t煤 puedes ver esta clave</p>
                                </div>
                                <div class="flex space-x-3">
                                    <button onclick="saveApiKey('openai')" class="btn-primary flex-1 py-3 rounded-xl font-semibold bg-gradient-to-r from-green-500 to-emerald-600">
                                        <i class="fas fa-save mr-2"></i>Guardar API Key
                                    </button>
                                    <button onclick="deleteApiKey('openai')" class="btn-danger px-4 py-3 rounded-xl font-semibold">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- GROK -->
                    <div id="api-grok" class="api-content hidden">
                        <div class="glass-panel p-6 rounded-xl border border-orange-500/30 mb-6">
                            <h3 class="text-lg font-semibold text-orange-400 mb-4"> C贸mo obtener API Key de Grok (xAI)</h3>
                            <div class="space-y-3 text-sm text-gray-300">
                                <div class="step-card glass-panel p-3 rounded-lg">
                                    <p><strong>1.</strong> Ve a <a href="https://console.x.ai" target="_blank" class="text-orange-400">xAI Console</a></p>
                                </div>
                                <div class="step-card glass-panel p-3 rounded-lg">
                                    <p><strong>2.</strong> Inicia sesi贸n con tu cuenta de X/Twitter</p>
                                </div>
                                <div class="step-card glass-panel p-3 rounded-lg">
                                    <p><strong>3.</strong> Ve a "API Keys" y genera una nueva clave</p>
                                </div>
                            </div>
                        </div>
                        <div class="glass-panel p-6 rounded-xl border border-orange-500/30">
                            <h3 class="text-lg font-semibold mb-4 flex items-center">
                                <i class="fas fa-shield-alt text-green-400 mr-2"></i>Configuraci贸n Segura
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">API Key Grok (xAI) <span class="text-red-400">*</span></label>
                                    <div class="relative">
                                        <input type="password" id="apiKeyGrok" class="w-full px-4 py-3 input-field rounded-xl text-white placeholder-gray-400 pr-12" placeholder="xai-...">
                                        <button onclick="toggleVisibility('apiKeyGrok')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-400 mt-1"><i class="fas fa-lock mr-1"></i>Solo t煤 puedes ver esta clave</p>
                                </div>
                                <div class="flex space-x-3">
                                    <button onclick="saveApiKey('grok')" class="btn-primary flex-1 py-3 rounded-xl font-semibold bg-gradient-to-r from-orange-500 to-red-600">
                                        <i class="fas fa-save mr-2"></i>Guardar API Key
                                    </button>
                                    <button onclick="deleteApiKey('grok')" class="btn-danger px-4 py-3 rounded-xl font-semibold">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- META -->
                    <div id="api-meta" class="api-content hidden">
                        <div class="glass-panel p-6 rounded-xl border border-blue-600/30 mb-6">
                            <h3 class="text-lg font-semibold text-blue-500 mb-4"> C贸mo obtener API Key de Meta (Llama)</h3>
                            <div class="space-y-3 text-sm text-gray-300">
                                <div class="step-card glass-panel p-3 rounded-lg">
                                    <p><strong>1.</strong> Ve a <a href="https://developers.facebook.com/tools/explorer/" target="_blank" class="text-blue-500">Facebook Developers</a></p>
                                </div>
                                <div class="step-card glass-panel p-3 rounded-lg">
                                    <p><strong>2.</strong> Crea una aplicaci贸n o usa una existente</p>
                                </div>
                                <div class="step-card glass-panel p-3 rounded-lg">
                                    <p><strong>3.</strong> Genera un token de acceso con permisos para LLM</p>
                                </div>
                            </div>
                        </div>
                        <div class="glass-panel p-6 rounded-xl border border-blue-600/30">
                            <h3 class="text-lg font-semibold mb-4 flex items-center">
                                <i class="fas fa-shield-alt text-green-400 mr-2"></i>Configuraci贸n Segura
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Access Token Meta <span class="text-red-400">*</span></label>
                                    <div class="relative">
                                        <input type="password" id="apiKeyMeta" class="w-full px-4 py-3 input-field rounded-xl text-white placeholder-gray-400 pr-12" placeholder="EAA...">
                                        <button onclick="toggleVisibility('apiKeyMeta')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-400 mt-1"><i class="fas fa-lock mr-1"></i>Solo t煤 puedes ver esta clave</p>
                                </div>
                                <div class="flex space-x-3">
                                    <button onclick="saveApiKey('meta')" class="btn-primary flex-1 py-3 rounded-xl font-semibold bg-gradient-to-r from-blue-600 to-indigo-600">
                                        <i class="fas fa-save mr-2"></i>Guardar API Key
                                    </button>
                                    <button onclick="deleteApiKey('meta')" class="btn-danger px-4 py-3 rounded-xl font-semibold">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- OLLAMA (FREE) -->
                    <div id="api-ollama" class="api-content hidden">
                        <div class="glass-panel p-6 rounded-xl border border-green-500/30 mb-6">
                            <h3 class="text-lg font-semibold text-green-400 mb-4"> Ollama (Local - Gratis)</h3>
                            <p class="text-sm text-gray-300 mb-4">Ollama ejecuta modelos localmente en tu computadora. No requiere API key, pero debes instalarlo.</p>
                            <div class="space-y-3 text-sm text-gray-300">
                                <div class="step-card glass-panel p-3 rounded-lg">
                                    <p><strong>1.</strong> Descarga e instala Ollama desde <a href="https://ollama.com/download" target="_blank" class="text-green-400">ollama.com</a></p>
                                </div>
                                <div class="step-card glass-panel p-3 rounded-lg">
                                    <p><strong>2.</strong> Abre terminal y ejecuta: <code class="bg-black/30 px-2 py-1 rounded">ollama pull llama3.2</code></p>
                                </div>
                                <div class="step-card glass-panel p-3 rounded-lg">
                                    <p><strong>3.</strong> Verifica que Ollama est茅 corriendo: <code class="bg-black/30 px-2 py-1 rounded">ollama list</code></p>
                                </div>
                            </div>
                        </div>
                        <div class="glass-panel p-6 rounded-xl border border-green-500/30">
                            <h3 class="text-lg font-semibold mb-4 flex items-center">
                                <i class="fas fa-shield-alt text-green-400 mr-2"></i>Configuraci贸n
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">URL del Servidor Ollama</label>
                                    <input type="text" id="apiUrlOllama" class="w-full px-4 py-3 input-field rounded-xl text-white placeholder-gray-400" value="http://localhost:11434">
                                    <p class="text-xs text-gray-400 mt-1">Por defecto: http://localhost:11434</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Modelo</label>
                                    <select id="apiModelOllama" class="w-full px-4 py-3 input-field rounded-xl text-white bg-transparent">
                                        <option value="llama3.2" class="bg-gray-800">Llama 3.2</option>
                                        <option value="llama3.1" class="bg-gray-800">Llama 3.1</option>
                                        <option value="mistral" class="bg-gray-800">Mistral</option>
                                        <option value="codellama" class="bg-gray-800">Code Llama</option>
                                        <option value="phi3" class="bg-gray-800">Phi-3</option>
                                    </select>
                                </div>
                                <div class="flex space-x-3">
                                    <button onclick="saveApiKey('ollama')" class="btn-primary flex-1 py-3 rounded-xl font-semibold bg-gradient-to-r from-green-500 to-emerald-600">
                                        <i class="fas fa-save mr-2"></i>Guardar Configuraci贸n
                                    </button>
                                    <button onclick="deleteApiKey('ollama')" class="btn-danger px-4 py-3 rounded-xl font-semibold">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- GROQ (FREE) -->
                    <div id="api-groq" class="api-content hidden">
                        <div class="glass-panel p-6 rounded-xl border border-orange-500/30 mb-6">
                            <h3 class="text-lg font-semibold text-orange-400 mb-4"> Groq (API Gratis - L铆mite generoso)</h3>
                            <p class="text-sm text-gray-300 mb-4">Groq ofrece acceso gratuito a modelos como Llama 3, Mixtral con tokens gratuitos mensuales.</p>
                            <div class="space-y-3 text-sm text-gray-300">
                                <div class="step-card glass-panel p-3 rounded-lg">
                                    <p><strong>1.</strong> Ve a <a href="https://console.groq.com/keys" target="_blank" class="text-orange-400">Groq Console</a></p>
                                </div>
                                <div class="step-card glass-panel p-3 rounded-lg">
                                    <p><strong>2.</strong> Crea una cuenta gratuita</p>
                                </div>
                                <div class="step-card glass-panel p-3 rounded-lg">
                                    <p><strong>3.</strong> Ve a "API Keys" y genera una nueva clave</p>
                                </div>
                                <div class="step-card glass-panel p-3 rounded-lg">
                                    <p><strong>4.</strong> Copia tu API key (empieza con <code>gsk_...</code>)</p>
                                </div>
                            </div>
                        </div>
                        <div class="glass-panel p-6 rounded-xl border border-orange-500/30">
                            <h3 class="text-lg font-semibold mb-4 flex items-center">
                                <i class="fas fa-shield-alt text-green-400 mr-2"></i>Configuraci贸n Segura
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">API Key Groq <span class="text-red-400">*</span></label>
                                    <div class="relative">
                                        <input type="password" id="apiKeyGroq" class="w-full px-4 py-3 input-field rounded-xl text-white placeholder-gray-400 pr-12" placeholder="gsk_...">
                                        <button onclick="toggleVisibility('apiKeyGroq')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-400 mt-1"><i class="fas fa-lock mr-1"></i>Solo t煤 puedes ver esta clave</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Modelo</label>
                                    <select id="apiModelGroq" class="w-full px-4 py-3 input-field rounded-xl text-white bg-transparent">
                                        <option value="llama-3.3-70b-versatile" class="bg-gray-800">Llama 3.3 70B</option>
                                        <option value="llama-3.1-8b-instant" class="bg-gray-800">Llama 3.1 8B (Instant)</option>
                                        <option value="mixtral-8x7b-32768" class="bg-gray-800">Mixtral 8x7B</option>
                                        <option value="gemma2-9b-it" class="bg-gray-800">Gemma 2 9B</option>
                                    </select>
                                </div>
                                <div class="flex space-x-3">
                                    <button onclick="saveApiKey('groq')" class="btn-primary flex-1 py-3 rounded-xl font-semibold bg-gradient-to-r from-orange-500 to-red-600">
                                        <i class="fas fa-save mr-2"></i>Guardar API Key
                                    </button>
                                    <button onclick="deleteApiKey('groq')" class="btn-danger px-4 py-3 rounded-xl font-semibold">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- GEMMA (FREE via Google) -->
                    <div id="api-gemma" class="api-content hidden">
                        <div class="glass-panel p-6 rounded-xl border border-purple-500/30 mb-6">
                            <h3 class="text-lg font-semibold text-purple-400 mb-4"> Google Gemma (Gratis con Gemini API)</h3>
                            <p class="text-sm text-gray-300 mb-4">Gemma es el modelo open source de Google. Puedes usarlo gratis con la misma API de Gemini o via Ollama local.</p>
                            <div class="space-y-3 text-sm text-gray-300">
                                <div class="step-card glass-panel p-3 rounded-lg">
                                    <p><strong>Opci贸n 1:</strong> Usa tu Gemini API Key (m谩s arriba )</p>
                                </div>
                                <div class="step-card glass-panel p-3 rounded-lg">
                                    <p><strong>Opci贸n 2:</strong> Descarga Gemma desde <a href="https://ollama.com/library/gemma" target="_blank" class="text-purple-400">Ollama</a> para uso local 100% gratis</p>
                                </div>
                                <div class="step-card glass-panel p-3 rounded-lg">
                                    <p><strong>Opci贸n 3:</strong> Usa <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-purple-400">Google AI Studio</a> (gratis con l铆mite)</p>
                                </div>
                            </div>
                        </div>
                        <div class="glass-panel p-6 rounded-xl border border-purple-500/30">
                            <h3 class="text-lg font-semibold mb-4 flex items-center">
                                <i class="fas fa-shield-alt text-green-400 mr-2"></i>Configuraci贸n (Opcional)
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Google AI Studio API Key (para Gemma)</label>
                                    <div class="relative">
                                        <input type="password" id="apiKeyGemma" class="w-full px-4 py-3 input-field rounded-xl text-white placeholder-gray-400 pr-12" placeholder="AIza... (opcional si ya tienes Gemini)">
                                        <button onclick="toggleVisibility('apiKeyGemma')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-400 mt-1">Deja vac铆o para usar la misma API Key de Gemini</p>
                                </div>
                                <div class="flex space-x-3">
                                    <button onclick="saveApiKey('gemma')" class="btn-primary flex-1 py-3 rounded-xl font-semibold bg-gradient-to-r from-purple-500 to-indigo-600">
                                        <i class="fas fa-save mr-2"></i>Guardar API Key
                                    </button>
                                    <button onclick="deleteApiKey('gemma')" class="btn-danger px-4 py-3 rounded-xl font-semibold">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- MY SKILLS SECTION -->
            <div id="mySkillsSection" class="section-hidden">
                <div class="glass-panel rounded-2xl p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center">
                            <div class="w-16 h-16 bg-gradient-to-br from-cyan-400 to-blue-600 rounded-2xl flex items-center justify-center mr-4 shadow-lg">
                                <i class="fas fa-cubes text-3xl"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold">Mis Skills</h2>
                                <p class="text-sm text-gray-300">Skills creadas y guardadas</p>
                            </div>
                        </div>
                        <button onclick="showSection('createSkill')" class="btn-primary px-6 py-3 rounded-xl font-semibold">
                            <i class="fas fa-plus mr-2"></i>Nueva Skill
                        </button>
                    </div>

                    <!-- Skills Grid -->
                    <div id="skillsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Skills will be loaded here dynamically -->
                        <div class="glass-panel p-6 rounded-xl text-center text-gray-400">
                            <i class="fas fa-cube text-4xl mb-3 text-gray-600"></i>
                            <p>No tienes skills guardadas</p>
                            <button onclick="showSection('createSkill')" class="mt-3 text-cyan-400 hover:text-cyan-300 text-sm">
                                Crea tu primera skill 
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CREATE SKILL SECTION -->
            <div id="createSkillSection" class="section-hidden">
                <div class="glass-panel rounded-2xl p-6 mb-6">
                    <div class="flex items-center mb-6">
                        <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-600 rounded-2xl flex items-center justify-center mr-4 shadow-lg">
                            <i class="fas fa-code text-3xl"></i>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold">Crear Skill Avanzado</h2>
                            <p class="text-sm text-gray-300">Editor de c贸digo con asistente IA</p>
                        </div>
                    </div>

                    <!-- Skill Info -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium mb-2">Nombre de la Skill <span class="text-red-400">*</span></label>
                            <input type="text" id="skillName" class="w-full px-4 py-3 input-field rounded-xl text-white placeholder-gray-400" placeholder="ej: calculadora_avanzada">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Categor铆a</label>
                            <select id="skillCategory" class="w-full px-4 py-3 input-field rounded-xl text-white bg-transparent">
                                <option value="utility" class="bg-gray-800">Utilidad</option>
                                <option value="automation" class="bg-gray-800">Automatizaci贸n</option>
                                <option value="analysis" class="bg-gray-800">An谩lisis</option>
                                <option value="communication" class="bg-gray-800">Comunicaci贸n</option>
                                <option value="custom" class="bg-gray-800">Personalizada</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Versi贸n</label>
                            <input type="text" id="skillVersion" class="w-full px-4 py-3 input-field rounded-xl text-white placeholder-gray-400" placeholder="1.0.0" value="1.0.0">
                        </div>
                    </div>

                    <!-- Editor and Chat Layout -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Code Editor -->
                        <div class="glass-panel rounded-xl p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-semibold flex items-center">
                                    <i class="fas fa-file-code mr-2 text-cyan-400"></i>Editor de C贸digo
                                </h3>
                                <div class="flex space-x-2">
                                    <button onclick="formatCode()" class="px-3 py-1 bg-white/10 rounded-lg hover:bg-white/20 transition text-sm">
                                        <i class="fas fa-magic mr-1"></i>Formatear
                                    </button>
                                    <button onclick="clearCode()" class="px-3 py-1 bg-white/10 rounded-lg hover:bg-white/20 transition text-sm">
                                        <i class="fas fa-trash mr-1"></i>Limpiar
                                    </button>
                                </div>
                            </div>
                            <textarea id="skillCode" class="w-full h-96 px-4 py-3 input-field rounded-xl text-white font-mono text-sm resize-none" placeholder="# Escribe tu c贸digo Python aqu铆
# Ejemplo de skill:

def main(context):
    '''
    Skill de ejemplo que saluda al usuario
    '''
    nombre = context.get('nombre', 'Usuario')
    return {
        'success': True,
        'message': f'Hola, {nombre}!'
    }

if __name__ == '__main__':
    # Prueba local
    resultado = main({'nombre': 'MININA'})
    print(resultado)"></textarea>
                        </div>

                        <!-- AI Assistant Chat -->
                        <div class="glass-panel rounded-xl p-4 flex flex-col">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-semibold flex items-center">
                                    <i class="fas fa-robot mr-2 text-purple-400"></i>Asistente IA
                                </h3>
                                <!-- API Selector Dropdown -->
                                <div class="relative">
                                    <button onclick="toggleApiSelector()" class="px-3 py-1 bg-gradient-to-r from-purple-500 to-pink-600 rounded-lg hover:opacity-90 transition text-sm flex items-center">
                                        <i class="fas fa-brain mr-2"></i>
                                        <span id="currentApiName">Gemini</span>
                                        <i class="fas fa-chevron-down ml-2"></i>
                                    </button>
                                    <!-- API Selector Menu -->
                                    <div id="apiSelectorMenu" class="hidden absolute right-0 mt-2 w-48 glass-panel rounded-xl border border-white/20 z-50">
                                        <button onclick="selectApi('gemini')" class="w-full text-left px-4 py-2 hover:bg-white/10 transition flex items-center rounded-t-xl">
                                            <i class="fas fa-brain w-6 text-blue-400"></i>Gemini
                                        </button>
                                        <button onclick="selectApi('openai')" class="w-full text-left px-4 py-2 hover:bg-white/10 transition flex items-center">
                                            <i class="fab fa-openai w-6 text-green-400"></i>ChatGPT
                                        </button>
                                        <button onclick="selectApi('ollama')" class="w-full text-left px-4 py-2 hover:bg-white/10 transition flex items-center">
                                            <i class="fas fa-server w-6 text-green-400"></i>Ollama 
                                        </button>
                                        <button onclick="selectApi('groq')" class="w-full text-left px-4 py-2 hover:bg-white/10 transition flex items-center">
                                            <i class="fas fa-bolt w-6 text-orange-400"></i>Groq 
                                        </button>
                                        <button onclick="selectApi('grok')" class="w-full text-left px-4 py-2 hover:bg-white/10 transition flex items-center">
                                            <i class="fas fa-robot w-6 text-orange-400"></i>Grok
                                        </button>
                                        <button onclick="selectApi('meta')" class="w-full text-left px-4 py-2 hover:bg-white/10 transition flex items-center">
                                            <i class="fab fa-meta w-6 text-blue-400"></i>Meta
                                        </button>
                                        <button onclick="selectApi('gemma')" class="w-full text-left px-4 py-2 hover:bg-white/10 transition flex items-center rounded-b-xl">
                                            <i class="fas fa-gem w-6 text-purple-400"></i>Gemma 
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Chat Messages -->
                            <div id="skillChatMessages" class="flex-1 overflow-y-auto mb-3 space-y-2 p-3 bg-black/20 rounded-xl" style="height: 300px; max-height: 300px; scroll-behavior: smooth;">
                                <div class="text-center py-4 text-gray-400 text-sm">
                                    <i class="fas fa-robot text-2xl mb-2 text-purple-400"></i>
                                    <p>Asistente para crear skills</p>
                                    <p class="text-xs mt-1">P铆deme que genere c贸digo o te ayude a depurar</p>
                                </div>
                            </div>

                            <!-- Chat Input -->
                            <div class="flex space-x-2">
                                <input type="text" id="skillChatInput" class="flex-1 px-4 py-2 input-field rounded-xl text-white placeholder-gray-400 text-sm" placeholder="Pide ayuda para tu skill...">
                                <button onclick="sendSkillChatMessage()" class="btn-primary px-4 py-2 rounded-xl">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-wrap gap-3 mt-6">
                        <button onclick="saveSkill()" class="btn-primary flex-1 py-3 rounded-xl font-semibold">
                            <i class="fas fa-save mr-2"></i>Guardar Skill
                        </button>
                        <button onclick="runSandboxValidation()" class="px-6 py-3 bg-purple-500/20 border border-purple-500/50 text-purple-400 rounded-xl hover:bg-purple-500/30 transition font-semibold">
                            <i class="fas fa-shield-alt mr-2"></i>Validar Sandbox
                        </button>
                        <button onclick="testSkill()" class="px-6 py-3 bg-yellow-500/20 border border-yellow-500/50 text-yellow-400 rounded-xl hover:bg-yellow-500/30 transition font-semibold">
                            <i class="fas fa-play mr-2"></i>Probar
                        </button>
                        <button onclick="clearSkillForm()" class="btn-danger px-6 py-3 rounded-xl font-semibold">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>

                    <!-- Sandbox Validation Result -->
                    <div id="sandboxResult" class="hidden mt-6">
                        <div class="glass-panel rounded-xl p-4 border-l-4" id="sandboxResultBox">
                            <div class="flex items-start">
                                <i id="sandboxIcon" class="fas fa-shield-alt text-2xl mr-3 mt-1"></i>
                                <div class="flex-1">
                                    <h4 id="sandboxTitle" class="font-semibold text-lg mb-1"></h4>
                                    <p id="sandboxDescription" class="text-sm mb-2"></p>
                                    <div id="sandboxRisks" class="hidden">
                                        <p class="text-xs text-gray-400 mb-1">Riesgos detectados:</p>
                                        <ul id="sandboxRisksList" class="text-xs space-y-1 max-h-32 overflow-y-auto"></ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WORKS SECTION - Archivos generados por skills -->
            <div id="worksSection" class="section-hidden">
                <div class="glass-panel rounded-2xl p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center">
                            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center mr-4 shadow-lg">
                                <i class="fas fa-folder-open text-3xl"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold">Works</h2>
                                <p class="text-sm text-gray-300">Archivos generados por tus skills</p>
                            </div>
                        </div>
                        <button onclick="loadWorksStats()" class="px-4 py-2 bg-white/10 rounded-xl hover:bg-white/20 transition">
                            <i class="fas fa-sync-alt mr-2"></i>Actualizar
                        </button>
                    </div>

                    <!-- Categories Grid -->
                    <div id="worksCategories" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
                        <!-- Categories loaded dynamically -->
                    </div>

                    <!-- Works List -->
                    <div class="glass-panel rounded-xl p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold flex items-center">
                                <i class="fas fa-files mr-2 text-blue-400"></i>
                                <span id="worksCategoryTitle">Todos los archivos</span>
                            </h3>
                            <div class="flex space-x-2">
                                <button onclick="loadWorks('all')" class="px-3 py-1 bg-white/10 rounded-lg hover:bg-white/20 transition text-sm">Todos</button>
                                <button onclick="loadWorks('imagenes')" class="px-3 py-1 bg-white/10 rounded-lg hover:bg-white/20 transition text-sm">Im谩genes</button>
                                <button onclick="loadWorks('videos')" class="px-3 py-1 bg-white/10 rounded-lg hover:bg-white/20 transition text-sm">Videos</button>
                                <button onclick="loadWorks('pdfs')" class="px-3 py-1 bg-white/10 rounded-lg hover:bg-white/20 transition text-sm">PDFs</button>
                                <button onclick="loadWorks('software')" class="px-3 py-1 bg-white/10 rounded-lg hover:bg-white/20 transition text-sm">Software</button>
                            </div>
                        </div>
                        <div id="worksList" class="space-y-2 max-h-96 overflow-y-auto">
                            <div class="text-center py-8 text-gray-400">
                                <i class="fas fa-folder-open text-4xl mb-3 text-gray-600"></i>
                                <p>No hay archivos generados a煤n</p>
                                <p class="text-xs mt-1">Las skills guardar谩n aqu铆 sus archivos</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AUDITORIA SECTION - Registro de ejecuciones -->
            <div id="auditoriaSection" class="section-hidden">
                <div class="glass-panel rounded-2xl p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center">
                            <div class="w-16 h-16 bg-gradient-to-br from-orange-500 to-red-600 rounded-2xl flex items-center justify-center mr-4 shadow-lg">
                                <i class="fas fa-clipboard-list text-3xl"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold">Auditor铆a General</h2>
                                <p class="text-sm text-gray-300">Historial de ejecuciones (30 d铆as)</p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="loadAuditoriaStats()" class="px-4 py-2 bg-white/10 rounded-xl hover:bg-white/20 transition">
                                <i class="fas fa-chart-bar mr-2"></i>Estad铆sticas
                            </button>
                            <button onclick="loadAuditoria()" class="px-4 py-2 bg-white/10 rounded-xl hover:bg-white/20 transition">
                                <i class="fas fa-sync-alt mr-2"></i>Actualizar
                            </button>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div id="auditoriaStats" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="glass-panel p-4 rounded-xl text-center">
                            <div class="text-3xl font-bold text-white" id="auditTotal">-</div>
                            <p class="text-xs text-gray-400">Total Ejecuciones</p>
                        </div>
                        <div class="glass-panel p-4 rounded-xl text-center">
                            <div class="text-3xl font-bold text-green-400" id="auditCompleted">-</div>
                            <p class="text-xs text-gray-400">Completadas</p>
                        </div>
                        <div class="glass-panel p-4 rounded-xl text-center">
                            <div class="text-3xl font-bold text-red-400" id="auditFailed">-</div>
                            <p class="text-xs text-gray-400">Fallidas</p>
                        </div>
                        <div class="glass-panel p-4 rounded-xl text-center">
                            <div class="text-3xl font-bold text-yellow-400" id="auditRunning">-</div>
                            <p class="text-xs text-gray-400">En ejecuci贸n</p>
                        </div>
                    </div>

                    <!-- Auditor铆a List -->
                    <div class="glass-panel rounded-xl p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold flex items-center">
                                <i class="fas fa-history mr-2 text-orange-400"></i>
                                Registro de Actividad
                            </h3>
                            <span class="text-xs text-gray-400 bg-black/20 px-3 py-1 rounded-full">
                                <i class="fas fa-lock mr-1"></i>Retenci贸n: 30 d铆as
                            </span>
                        </div>
                        <div id="auditoriaList" class="space-y-2 max-h-96 overflow-y-auto">
                            <div class="text-center py-8 text-gray-400">
                                <i class="fas fa-clipboard-list text-4xl mb-3 text-gray-600"></i>
                                <p>No hay registros de auditor铆a</p>
                                <p class="text-xs mt-1">Las ejecuciones de skills aparecer谩n aqu铆</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Right Sidebar Menu -->
        <aside id="sidebar" class="fixed right-0 top-0 h-full w-80 glass-panel z-50 transform translate-x-full lg:translate-x-0 transition-transform duration-300 overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-8 lg:hidden">
                    <h3 class="text-xl font-bold">Men煤</h3>
                    <button onclick="toggleMenu()" class="p-2 hover:bg-white/10 rounded-lg">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <nav class="space-y-2">
                    <button onclick="showSection('dashboard')" id="menu-dashboard" class="sidebar-item active w-full text-left px-4 py-3 rounded-xl flex items-center">
                        <i class="fas fa-home w-8 text-cyan-400"></i><span>Dashboard</span>
                    </button>
                    
                    <div class="pt-4 border-t border-white/10">
                        <p class="text-xs text-gray-400 uppercase tracking-wider mb-3 px-4">Skills</p>
                        
                        <button onclick="showSection('mySkills')" id="menu-mySkills" class="sidebar-item w-full text-left px-4 py-3 rounded-xl flex items-center">
                            <i class="fas fa-cubes w-8 text-cyan-400"></i>
                            <div><span class="block">Mis Skills</span><span class="text-xs text-gray-400">Skills guardadas</span></div>
                        </button>
                        
                        <button onclick="showSection('createSkill')" id="menu-createSkill" class="sidebar-item w-full text-left px-4 py-3 rounded-xl flex items-center">
                            <i class="fas fa-code w-8 text-purple-400"></i>
                            <div><span class="block">Crear Skill</span><span class="text-xs text-gray-400">Editor avanzado</span></div>
                        </button>
                    </div>
                    
                    <div class="pt-4 border-t border-white/10">
                        <p class="text-xs text-gray-400 uppercase tracking-wider mb-3 px-4">Integraciones</p>
                        
                        <button onclick="showSection('apis')" id="menu-apis" class="sidebar-item w-full text-left px-4 py-3 rounded-xl flex items-center">
                            <i class="fas fa-key w-8 text-purple-400"></i>
                            <div><span class="block">API Keys</span><span class="text-xs text-gray-400">7 proveedores</span></div>
                        </button>
                        
                        <button onclick="showSection('telegram')" id="menu-telegram" class="sidebar-item w-full text-left px-4 py-3 rounded-xl flex items-center">
                            <i class="fab fa-telegram w-8 text-blue-400"></i>
                            <div><span class="block">Telegram</span><span id="sidebar-tg-status" class="text-xs text-gray-400">Desconectado</span></div>
                        </button>
                        
                        <button onclick="showSection('whatsapp')" id="menu-whatsapp" class="sidebar-item w-full text-left px-4 py-3 rounded-xl flex items-center">
                            <i class="fab fa-whatsapp w-8 text-green-400"></i>
                            <div><span class="block">WhatsApp</span><span id="sidebar-wa-status" class="text-xs text-gray-400">Desconectado</span></div>
                        </button>
                    </div>
                    
                    <div class="pt-4 border-t border-white/10">
                        <p class="text-xs text-gray-400 uppercase tracking-wider mb-3 px-4">Trabajos</p>
                        
                        <button onclick="showSection('works')" id="menu-works" class="sidebar-item w-full text-left px-4 py-3 rounded-xl flex items-center">
                            <i class="fas fa-folder-open w-8 text-blue-400"></i>
                            <div><span class="block">Works</span><span class="text-xs text-gray-400">Archivos generados</span></div>
                        </button>
                        
                        <button onclick="showSection('auditoria')" id="menu-auditoria" class="sidebar-item w-full text-left px-4 py-3 rounded-xl flex items-center">
                            <i class="fas fa-clipboard-list w-8 text-orange-400"></i>
                            <div><span class="block">Auditor铆a</span><span class="text-xs text-gray-400">Historial 30 d铆as</span></div>
                        </button>
                    </div>
                    
                    <div class="pt-4 border-t border-white/10">
                        <p class="text-xs text-gray-400 uppercase tracking-wider mb-3 px-4">Sistema</p>
                        <button onclick="showMemoryStats()" class="sidebar-item w-full text-left px-4 py-3 rounded-xl flex items-center">
                            <i class="fas fa-brain w-8 text-pink-400"></i><span>Memoria</span>
                        </button>
                        <button onclick="showSystemStatus()" class="sidebar-item w-full text-left px-4 py-3 rounded-xl flex items-center">
                            <i class="fas fa-cog w-8 text-yellow-400"></i><span>Estado</span>
                        </button>
                        <a href="/api/docs" target="_blank" class="sidebar-item w-full text-left px-4 py-3 rounded-xl flex items-center">
                            <i class="fas fa-book w-8 text-gray-400"></i><span>API Docs</span>
                        </a>
                    </div>
                </nav>

                <div class="mt-8 p-4 bg-black/20 rounded-xl">
                    <p class="text-xs text-gray-400 mb-1">Session ID:</p>
                    <p class="text-xs font-mono text-cyan-400 break-all" id="sessionId">-</p>
                    <button onclick="newSession()" class="mt-2 text-xs px-3 py-1 bg-white/10 rounded-lg hover:bg-white/20 transition w-full">
                        <i class="fas fa-refresh mr-1"></i> Nueva Sesi贸n
                    </button>
                </div>
            </div>
        </aside>
    </div>

    <!-- Restart Modal -->
    <div id="restartModal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-black/70" onclick="closeRestartModal()"></div>
        <div class="glass-panel rounded-2xl p-8 max-w-md mx-4 relative z-10 text-center">
            <div class="w-16 h-16 bg-yellow-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-exclamation-triangle text-3xl text-yellow-400"></i>
            </div>
            <h3 class="text-xl font-bold mb-2">Reinicio Requerido</h3>
            <p class="text-gray-300 mb-6">Para conectar con <span id="restartService"></span>, MININA necesita reiniciarse.<br><br><strong>驴Deseas continuar?</strong></p>
            <div class="flex space-x-3">
                <button onclick="closeRestartModal()" class="flex-1 py-3 bg-white/10 rounded-xl hover:bg-white/20 transition">Cancelar</button>
                <button onclick="confirmRestart()" class="flex-1 py-3 btn-primary rounded-xl font-semibold"><i class="fas fa-power-off mr-2"></i>Reiniciar</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed bottom-4 left-4 z-50 space-y-2"></div>

    <script>
        let sessionId = 'session_' + Math.random().toString(36).substr(2, 9);
        let currentConfig = {};
        let pendingService = '';
        
        // Skill Management Functions
        let currentSkillApi = 'gemini';
        let mySkills = [];
        let lastValidationResult = null;

        function toggleApiSelector() {
            const menu = document.getElementById('apiSelectorMenu');
            menu.classList.toggle('hidden');
        }

        function selectApi(api) {
            currentSkillApi = api;
            const apiNames = {
                'gemini': 'Gemini',
                'openai': 'ChatGPT',
                'ollama': 'Ollama',
                'groq': 'Groq',
                'grok': 'Grok',
                'meta': 'Meta',
                'gemma': 'Gemma'
            };
            document.getElementById('currentApiName').textContent = apiNames[api];
            document.getElementById('apiSelectorMenu').classList.add('hidden');
            showToast('Conectado a ' + apiNames[api], 'success');
        }

        // Sandbox Validation Function
        async function runSandboxValidation() {
            const code = document.getElementById('skillCode').value;
            const name = document.getElementById('skillName').value || 'unnamed_skill';

            if (!code.trim()) {
                showToast('No hay c贸digo para validar', 'error');
                return;
            }

            showToast(' Validando con Sandbox...', 'info');

            try {
                const response = await fetch('http://127.0.0.1:8897/api/skills/validate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        code: code,
                        name: name,
                        permissions: []
                    })
                });

                const data = await response.json();
                lastValidationResult = data;

                // Show result box
                const resultBox = document.getElementById('sandboxResult');
                const resultContent = document.getElementById('sandboxResultBox');
                const icon = document.getElementById('sandboxIcon');
                const title = document.getElementById('sandboxTitle');
                const description = document.getElementById('sandboxDescription');
                const risksDiv = document.getElementById('sandboxRisks');
                const risksList = document.getElementById('sandboxRisksList');

                resultBox.classList.remove('hidden');

                // Reset classes
                resultContent.className = 'glass-panel rounded-xl p-4 border-l-4';
                icon.className = 'fas text-2xl mr-3 mt-1';

                if (data.level === 'HIGH') {
                    // NIVEL ALTO - RECHAZADA
                    resultContent.classList.add('border-red-500', 'bg-red-500/10');
                    icon.classList.add('fa-shield-virus', 'text-red-500');
                    title.textContent = ' SKILL RECHAZADA';
                    title.className = 'font-semibold text-lg mb-1 text-red-400';
                    description.textContent = 'Esta skill contiene c贸digo potencialmente peligroso que podr铆a comprometer tu sistema. No puede ser aprobada por el Sandbox de seguridad.';
                    description.className = 'text-sm mb-2 text-red-300';
                    
                    // Show high risks
                    if (data.high_risks && data.high_risks.length > 0) {
                        risksDiv.classList.remove('hidden');
                        risksList.innerHTML = data.high_risks.map(r => 
                            `<li class="text-red-400 flex items-center"><i class="fas fa-skull-crossbones mr-2"></i>${r}</li>`
                        ).join('');
                    }
                    
                    showToast(' Skill rechazada por seguridad', 'error');
                    
                } else if (data.level === 'MEDIUM') {
                    // NIVEL MEDIO - ADVERTENCIA
                    resultContent.classList.add('border-yellow-500', 'bg-yellow-500/10');
                    icon.classList.add('fa-exclamation-triangle', 'text-yellow-500');
                    title.textContent = '锔 APROBADA CON ADVERTENCIA';
                    title.className = 'font-semibold text-lg mb-1 text-yellow-400';
                    description.textContent = 'Esta skill tiene acceso a recursos externos (red, archivos). Revisa cuidadosamente el c贸digo antes de usarla en producci贸n.';
                    description.className = 'text-sm mb-2 text-yellow-300';
                    
                    // Show medium risks
                    if (data.medium_risks && data.medium_risks.length > 0) {
                        risksDiv.classList.remove('hidden');
                        risksList.innerHTML = data.medium_risks.map(r => 
                            `<li class="text-yellow-400 flex items-center"><i class="fas fa-exclamation-circle mr-2"></i>${r}</li>`
                        ).join('');
                    }
                    
                    showToast('锔 Skill aprobada con advertencias', 'warning');
                    
                } else {
                    // NIVEL BAJO - SEGURA
                    resultContent.classList.add('border-green-500', 'bg-green-500/10');
                    icon.classList.add('fa-shield-alt', 'text-green-500');
                    title.textContent = ' SKILL APROBADA';
                    title.className = 'font-semibold text-lg mb-1 text-green-400';
                    description.textContent = 'Excelente! Esta skill pas贸 todas las validaciones de seguridad. No detectamos riesgos significativos. Es segura para usar.';
                    description.className = 'text-sm mb-2 text-green-300';
                    risksDiv.classList.add('hidden');
                    
                    showToast(' Skill aprobada - Seguridad BAJA', 'success');
                }

            } catch (e) {
                showToast('Error en validaci贸n: ' + e.message, 'error');
            }
        }

        // Send code to editor from chat - automatic, no confirmation
        function sendCodeToEditor(code, description) {
            const currentCode = document.getElementById('skillCode').value;
            
            // Siempre reemplazar el c贸digo actual
            document.getElementById('skillCode').value = code;
            
            // Mostrar toast de confirmaci贸n
            showToast(' C贸digo actualizado en el editor', 'success');
        }

        async function sendSkillChatMessage() {
            const input = document.getElementById('skillChatInput');
            const message = input.value.trim();
            if (!message) return;

            addSkillChatMessage('user', message);
            input.value = '';

            // Get current code context
            const code = document.getElementById('skillCode').value;
            const skillName = document.getElementById('skillName').value || 'nueva_skill';

            // Show typing indicator
            addSkillChatMessage('typing', '...');

            try {
                // Prepare prompt with context - instrucciones espec铆ficas para generar c贸digo
                const fullPrompt = `Eres un asistente experto en Python que ayuda a crear skills para MININA.

Estoy creando una skill llamada "${skillName}". 

C贸digo actual en el editor:
\`\`\`python
${code || '# Editor vac铆o'}
\`\`\`

El usuario pide: "${message}"

INSTRUCCIONES CRTICAS:
1. NUNCA muestres el c贸digo en el chat. El c贸digo debe ir NICAMENTE dentro de los tags [CODIGO_INICIO]...[CODIGO_FIN].
2. En el chat solo escribe explicaciones, comentarios sobre cambios, o preguntas.
3. El c贸digo dentro de [CODIGO_INICIO]...[CODIGO_FIN] ser谩 enviado autom谩ticamente al editor.
4. Si el usuario pide corregir algo, solo indica qu茅 cambiaste en el chat, pero el c贸digo completo debe ir en los tags.
5. El c贸digo debe incluir la funci贸n execute(context) completa y lista para usar.
6. NO incluyas explicaciones dentro de los tags de c贸digo.

Estructura de respuesta:
- Explicaci贸n en el chat (sin c贸digo)
- [CODIGO_INICIO]
- c贸digo Python completo aqu铆
- [CODIGO_FIN]

Responde en espa帽ol.`;

                // Call API based on selection
                const response = await fetch('http://127.0.0.1:8897/api/chat/send', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        message: fullPrompt,
                        user_id: 'skill_creator',
                        session_id: sessionId,
                        provider: currentSkillApi
                    })
                });

                const data = await response.json();
                
                // Remove typing indicator
                const typingMsg = document.querySelector('#skillChatMessages .typing-message');
                if (typingMsg) typingMsg.remove();

                if (data.success) {
                    let responseText = data.response;
                    let codeToSend = null;
                    
                    // Extract code if present
                    const codeMatch = responseText.match(/\[CODIGO_INICIO\]([\s\S]*?)\[CODIGO_FIN\]/);
                    if (codeMatch) {
                        codeToSend = codeMatch[1].trim();
                        // Remove code tags from display text
                        responseText = responseText.replace(/\[CODIGO_INICIO\][\s\S]*?\[CODIGO_FIN\]/, '').trim();
                        
                        // Show only explanation in chat
                        addSkillChatMessage('assistant', responseText || 'He generado el c贸digo para tu skill. Revisa el editor ');
                        
                        // Send code directly to editor automatically
                        sendCodeToEditor(codeToSend, null);
                    } else {
                        // No code, just show the response
                        addSkillChatMessage('assistant', responseText);
                    }
                } else {
                    addSkillChatMessage('assistant', 'Error: No se pudo conectar con ' + currentSkillApi + '. Verifica que la API est茅 configurada correctamente en la secci贸n de APIs.');
                }
            } catch (e) {
                // Remove typing indicator
                const typingMsg = document.querySelector('#skillChatMessages .typing-message');
                if (typingMsg) typingMsg.remove();
                
                addSkillChatMessage('assistant', 'Error de conexi贸n: ' + e.message + '. Verifica que la API ' + currentSkillApi + ' est茅 configurada.');
            }
        }

        function addSkillChatMessage(role, content) {
            const container = document.getElementById('skillChatMessages');
            const div = document.createElement('div');
            
            if (role === 'typing') {
                div.className = 'typing-message flex justify-start';
                div.innerHTML = `
                    <div class="flex items-start space-x-2 max-w-[80%]">
                        <i class="fas fa-robot mt-1 text-purple-400"></i>
                        <div class="bg-white/20 px-3 py-2 rounded-xl">
                            <span class="animate-pulse">Escribiendo...</span>
                        </div>
                    </div>`;
            } else {
                div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
                const bg = role === 'user' ? 'bg-cyan-600' : 'bg-white/20';
                const icon = role === 'user' ? 'fa-user' : 'fa-robot';
                
                div.innerHTML = `
                    <div class="flex items-start space-x-2 max-w-[80%]">
                        ${role === 'assistant' ? `<i class="fas ${icon} mt-1 text-purple-400"></i>` : ''}
                        <div class="${bg} px-3 py-2 rounded-xl">
                            <p class="text-sm whitespace-pre-wrap">${content}</p>
                        </div>
                        ${role === 'user' ? `<i class="fas ${icon} mt-1 text-gray-400"></i>` : ''}
                    </div>`;
            }
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function formatCode() {
            const code = document.getElementById('skillCode').value;
            // Simple formatting - add proper indentation
            const lines = code.split('\n');
            let formatted = '';
            let indent = 0;
            
            lines.forEach(line => {
                const trimmed = line.trim();
                if (trimmed.endsWith(':')) {
                    formatted += '    '.repeat(indent) + trimmed + '\n';
                    indent++;
                } else if (trimmed.startsWith('return') || trimmed.startsWith('pass')) {
                    indent = Math.max(0, indent - 1);
                    formatted += '    '.repeat(indent) + trimmed + '\n';
                } else {
                    formatted += '    '.repeat(indent) + trimmed + '\n';
                }
            });
            
            document.getElementById('skillCode').value = formatted.trim();
            showToast('C贸digo formateado', 'success');
        }

        function clearCode() {
            if (confirm('驴Limpiar todo el c贸digo?')) {
                document.getElementById('skillCode').value = '';
            }
        }

        async function saveSkill() {
            const name = document.getElementById('skillName').value.trim();
            const category = document.getElementById('skillCategory').value;
            const version = document.getElementById('skillVersion').value;
            const code = document.getElementById('skillCode').value.trim();

            if (!name) {
                showToast('Nombre de skill es requerido', 'error');
                return;
            }
            if (!code) {
                showToast('El c贸digo es requerido', 'error');
                return;
            }

            // Check if editing existing skill
            const existingId = document.getElementById('skillCode').dataset.editingId;
            const skillId = existingId || 'skill_' + Date.now();

            const skill = {
                id: skillId,
                name: name,
                category: category,
                version: version,
                code: code,
                description: '',
                created_at: new Date().toISOString()
            };

            try {
                // Save to backend permanently
                const response = await fetch('http://127.0.0.1:8897/api/skills/user/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(skill)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Skill "' + name + '" guardada permanentemente', 'success');
                    loadMySkills();
                    
                    // Clear form
                    document.getElementById('skillName').value = '';
                    document.getElementById('skillCode').value = '';
                    delete document.getElementById('skillCode').dataset.editingId;
                } else {
                    showToast('Error: ' + data.error, 'error');
                }
            } catch (e) {
                showToast('Error al guardar skill: ' + e.message, 'error');
            }
        }

        async function testSkill() {
            const code = document.getElementById('skillCode').value;
            const name = document.getElementById('skillName').value || 'test_skill';

            if (!code.trim()) {
                showToast('No hay c贸digo para probar', 'error');
                return;
            }

            try {
                const response = await fetch('http://127.0.0.1:8897/api/skills/validate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({code: code, name: name})
                });

                const data = await response.json();
                
                if (data.valid) {
                    showToast(' C贸digo v谩lido - Sin errores de sintaxis', 'success');
                } else {
                    showToast(' Error: ' + data.error, 'error');
                }
            } catch (e) {
                showToast('Error al validar: ' + e.message, 'error');
            }
        }

        function clearSkillForm() {
            if (confirm('驴Limpiar todo el formulario?')) {
                document.getElementById('skillName').value = '';
                document.getElementById('skillVersion').value = '1.0.0';
                document.getElementById('skillCode').value = '';
                document.getElementById('skillCategory').value = 'utility';
            }
        }

        async function loadMySkills() {
            try {
                // Load from backend
                const response = await fetch('http://127.0.0.1:8897/api/skills/user/list');
                const data = await response.json();
                
                if (data.success) {
                    mySkills = data.skills || [];
                } else {
                    mySkills = [];
                }
                
                // MIGRACIN: Si no hay skills en backend pero hay en localStorage, migrarlas
                if (mySkills.length === 0) {
                    const localSkills = localStorage.getItem('minina_skills');
                    if (localSkills) {
                        try {
                            const oldSkills = JSON.parse(localSkills);
                            if (oldSkills && oldSkills.length > 0) {
                                showToast(' Migrando ' + oldSkills.length + ' skills al servidor...', 'info');
                                
                                // Migrar cada skill al backend
                                for (const skill of oldSkills) {
                                    await fetch('http://127.0.0.1:8897/api/skills/user/save', {
                                        method: 'POST',
                                        headers: {'Content-Type': 'application/json'},
                                        body: JSON.stringify(skill)
                                    });
                                }
                                
                                // Limpiar localStorage despu茅s de migrar
                                localStorage.removeItem('minina_skills');
                                
                                // Recargar skills desde backend
                                const newResponse = await fetch('http://127.0.0.1:8897/api/skills/user/list');
                                const newData = await newResponse.json();
                                if (newData.success) {
                                    mySkills = newData.skills || [];
                                }
                                
                                showToast(' Skills migradas correctamente al servidor', 'success');
                            }
                        } catch (e) {
                            console.error('Error migrando skills:', e);
                        }
                    }
                }

                const container = document.getElementById('skillsGrid');
                
                if (mySkills.length === 0) {
                    container.innerHTML = `
                        <div class="glass-panel p-6 rounded-xl text-center text-gray-400 col-span-full">
                            <i class="fas fa-cube text-4xl mb-3 text-gray-600"></i>
                            <p>No tienes skills guardadas</p>
                            <button onclick="showSection('createSkill')" class="mt-3 text-cyan-400 hover:text-cyan-300 text-sm">
                                Crea tu primera skill 
                            </button>
                        </div>`;
                    return;
                }

                container.innerHTML = mySkills.map(skill => {
                    const categoryColors = {
                        'utility': 'text-cyan-400',
                        'automation': 'text-green-400',
                        'analysis': 'text-purple-400',
                        'communication': 'text-blue-400',
                        'custom': 'text-yellow-400'
                    };
                    
                    const categoryIcons = {
                        'utility': 'fa-wrench',
                        'automation': 'fa-cogs',
                        'analysis': 'fa-chart-line',
                        'communication': 'fa-comments',
                        'custom': 'fa-star'
                    };

                    return `
                        <div class="glass-panel p-5 rounded-xl card-hover">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex items-center">
                                    <i class="fas ${categoryIcons[skill.category] || 'fa-cube'} text-xl ${categoryColors[skill.category] || 'text-gray-400'} mr-3"></i>
                                    <div>
                                        <h4 class="font-semibold">${skill.name}</h4>
                                        <p class="text-xs text-gray-400">v${skill.version}</p>
                                    </div>
                                </div>
                                <button onclick="deleteMySkill('${skill.id}')" class="text-red-400 hover:text-red-300">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <p class="text-xs text-gray-400 mb-3">${skill.category}</p>
                            <div class="flex space-x-2">
                                <button onclick="editSkill('${skill.id}')" class="flex-1 py-2 bg-white/10 rounded-lg hover:bg-white/20 transition text-sm">
                                    <i class="fas fa-edit mr-1"></i>Editar
                                </button>
                                <button onclick="runSkill('${skill.id}')" class="flex-1 py-2 bg-cyan-500/20 text-cyan-400 rounded-lg hover:bg-cyan-500/30 transition text-sm">
                                    <i class="fas fa-play mr-1"></i>Ejecutar
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('Error loading skills:', e);
                mySkills = [];
            }
        }

        function editSkill(id) {
            const skill = mySkills.find(s => s.id === id);
            if (!skill) return;

            document.getElementById('skillName').value = skill.name;
            document.getElementById('skillCategory').value = skill.category;
            document.getElementById('skillVersion').value = skill.version;
            document.getElementById('skillCode').value = skill.code;
            document.getElementById('skillCode').dataset.editingId = skill.id;

            showSection('createSkill');
            showToast('Skill cargada en el editor. Guardarla actualizar谩 la versi贸n existente.', 'info');
        }

        async function runSkill(id) {
            const skill = mySkills.find(s => s.id === id);
            if (!skill) return;

            showToast('Ejecutando "' + skill.name + '"...', 'info');
            
            try {
                // Execute skill code via backend
                const response = await fetch('http://127.0.0.1:8897/api/skills/execute', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        skill_name: skill.name,
                        code: skill.code,
                        context: {}
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(' Skill "' + skill.name + '" ejecutada correctamente', 'success');
                    if (data.result && data.result.message) {
                        showToast(data.result.message, 'info');
                    }
                } else {
                    showToast(' Error: ' + (data.error || 'Error desconocido'), 'error');
                }
            } catch (e) {
                showToast('Error ejecutando skill: ' + e.message, 'error');
            }
        }

        async function deleteMySkill(id) {
            if (!confirm('驴Eliminar esta skill permanentemente?')) return;
            
            try {
                const response = await fetch('http://127.0.0.1:8897/api/skills/user/' + id, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    loadMySkills();
                    showToast('Skill eliminada permanentemente', 'success');
                } else {
                    showToast('Error: ' + data.error, 'error');
                }
            } catch (e) {
                showToast('Error eliminando skill', 'error');
            }
        }

        // Close API selector when clicking outside
        document.addEventListener('click', function(e) {
            const selector = document.getElementById('apiSelectorMenu');
            const button = e.target.closest('button[onclick="toggleApiSelector()"]');
            if (!button && selector && !selector.contains(e.target)) {
                selector.classList.add('hidden');
            }
        });

        // Enter key for skill chat
        document.getElementById('skillChatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendSkillChatMessage();
        });     document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('sessionId').textContent = sessionId;
            loadStats();
            loadMySkills(); // Cargar skills al inicio
        });

        loadMySkills(); // Cargar skills al inicio

        function toggleMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('menuOverlay');
            sidebar.classList.toggle('translate-x-full');
            overlay.classList.toggle('active');
        }

        function showSection(section) {
            document.querySelectorAll('.section-visible').forEach(el => {
                el.classList.remove('section-visible');
                el.classList.add('section-hidden');
            });
            document.getElementById(section + 'Section').classList.remove('section-hidden');
            document.getElementById(section + 'Section').classList.add('section-visible');
            
            document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
            document.getElementById('menu-' + section).classList.add('active');
            toggleMenu();
        }

        function newSession() {
            sessionId = 'session_' + Math.random().toString(36).substr(2, 9);
            document.getElementById('sessionId').textContent = sessionId;
            document.getElementById('chatMessages').innerHTML = `
                <div class="text-center py-8 text-gray-400">
                    <i class="fas fa-robot text-4xl mb-2 text-cyan-400"></i>
                    <p>Nueva sesi贸n iniciada</p>
                </div>`;
            showToast('Nueva sesi贸n creada', 'info');
        }

        function toggleVisibility(id) {
            const input = document.getElementById(id);
            const btn = input.nextElementSibling;
            const icon = btn.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // API Provider Functions
        function showApiProvider(provider) {
            // Hide all API contents
            document.querySelectorAll('.api-content').forEach(el => el.classList.add('hidden'));
            // Show selected
            document.getElementById('api-' + provider).classList.remove('hidden');
            
            // Update tabs
            document.querySelectorAll('.api-tab').forEach(tab => {
                tab.classList.remove('active', 'bg-gradient-to-r', 'from-blue-500', 'to-blue-600', 'from-green-500', 'to-emerald-600', 'from-orange-500', 'to-red-600', 'from-purple-500', 'to-indigo-600');
                tab.classList.add('bg-white/10');
            });
            
            const activeTab = document.getElementById('tab-' + provider);
            activeTab.classList.remove('bg-white/10');
            activeTab.classList.add('active');
            
            // Add appropriate gradient
            const gradients = {
                'gemini': 'from-blue-500 to-blue-600',
                'openai': 'from-green-500 to-emerald-600',
                'grok': 'from-orange-500 to-red-600',
                'meta': 'from-blue-600 to-indigo-600',
                'ollama': 'from-green-500 to-emerald-600',
                'groq': 'from-orange-500 to-red-600',
                'gemma': 'from-purple-500 to-indigo-600'
            };
            activeTab.classList.add('bg-gradient-to-r', ...gradients[provider].split(' '));
        }

        async function saveApiKey(provider) {
            const keyMap = {
                'gemini': 'apiKeyGemini',
                'openai': 'apiKeyOpenAI',
                'grok': 'apiKeyGrok',
                'meta': 'apiKeyMeta',
                'gemma': 'apiKeyGemma',
                'groq': 'apiKeyGroq'
            };
            
            let key = '';
            if (keyMap[provider]) {
                key = document.getElementById(keyMap[provider]).value;
            }
            
            // Special handling for Ollama
            if (provider === 'ollama') {
                const url = document.getElementById('apiUrlOllama').value;
                const model = document.getElementById('apiModelOllama').value;
                
                try {
                    const response = await fetch('http://127.0.0.1:8897/api/apis/save', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            provider: 'ollama',
                            api_key: 'local',
                            base_url: url,
                            model: model
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        showToast('Configuraci贸n de Ollama guardada permanentemente', 'success');
                    } else {
                        showToast('Error: ' + data.error, 'error');
                    }
                } catch (e) {
                    showToast('Error de conexi贸n', 'error');
                }
                return;
            }
            
            // Special handling for Groq with model selection
            if (provider === 'groq') {
                const model = document.getElementById('apiModelGroq').value;
                if (!key) {
                    showToast('API Key de Groq es requerida', 'error');
                    return;
                }
                
                try {
                    const response = await fetch('http://127.0.0.1:8897/api/apis/save', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            provider: 'groq',
                            api_key: key,
                            model: model
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        showToast('API Key de Groq guardada permanentemente', 'success');
                        document.getElementById(keyMap[provider]).value = '';
                    } else {
                        showToast('Error: ' + data.error, 'error');
                    }
                } catch (e) {
                    showToast('Error de conexi贸n', 'error');
                }
                return;
            }
            
            if (!key) {
                showToast('API Key es requerida', 'error');
                return;
            }
            
            try {
                const response = await fetch('http://127.0.0.1:8897/api/apis/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        provider: provider,
                        api_key: key
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast('API Key de ' + provider.charAt(0).toUpperCase() + provider.slice(1) + ' guardada permanentemente', 'success');
                    document.getElementById(keyMap[provider]).value = '';
                } else {
                    showToast('Error: ' + data.error, 'error');
                }
            } catch (e) {
                showToast('Error de conexi贸n', 'error');
            }
        }

        async function deleteApiKey(provider) {
            const confirmMsg = {
                'gemini': '驴Eliminar API Key de Gemini permanentemente?',
                'openai': '驴Eliminar API Key de OpenAI permanentemente?',
                'grok': '驴Eliminar API Key de Grok permanentemente?',
                'meta': '驴Eliminar Access Token de Meta permanentemente?',
                'ollama': '驴Eliminar configuraci贸n de Ollama?',
                'groq': '驴Eliminar API Key de Groq permanentemente?',
                'gemma': '驴Eliminar API Key de Gemma permanentemente?'
            };
            
            if (!confirm(confirmMsg[provider])) return;
            
            try {
                const response = await fetch('http://127.0.0.1:8897/api/apis/delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        provider: provider
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    const keyMap = {
                        'gemini': 'apiKeyGemini',
                        'openai': 'apiKeyOpenAI',
                        'grok': 'apiKeyGrok',
                        'meta': 'apiKeyMeta',
                        'gemma': 'apiKeyGemma',
                        'groq': 'apiKeyGroq'
                    };
                    
                    if (keyMap[provider]) {
                        document.getElementById(keyMap[provider]).value = '';
                    }
                    
                    showToast('Configuraci贸n de ' + provider.charAt(0).toUpperCase() + provider.slice(1) + ' eliminada permanentemente', 'success');
                } else {
                    showToast('Error: ' + data.error, 'error');
                }
            } catch (e) {
                showToast('Error de conexi贸n', 'error');
            }
        }

        // Load saved API keys on page load
        async function loadSavedApiKeys() {
            try {
                const response = await fetch('http://127.0.0.1:8897/api/apis/list');
                const data = await response.json();
                
                if (data.success && data.providers) {
                    // Update UI to show which APIs are configured
                    for (const [provider, config] of Object.entries(data.providers)) {
                        if (config.has_key) {
                            // Show indicator that this API is configured
                            const tab = document.getElementById('tab-' + provider);
                            if (tab) {
                                const indicator = document.createElement('span');
                                indicator.className = 'ml-2 text-xs bg-green-500/30 text-green-400 px-2 py-0.5 rounded-full';
                                indicator.textContent = ' Configurado';
                                indicator.id = 'indicator-' + provider;
                                
                                // Remove existing indicator if present
                                const existing = document.getElementById('indicator-' + provider);
                                if (existing) existing.remove();
                                
                                tab.appendChild(indicator);
                            }
                        }
                    }
                    
                    console.log('APIs configuradas:', data.providers);
                }
            } catch (e) {
                console.error('Error cargando APIs configuradas:', e);
            }
        }

        // Load saved keys when page loads
        document.addEventListener('DOMContentLoaded', loadSavedApiKeys);

        async function loadStats() {
            try {
                const res = await fetch('http://127.0.0.1:8897/api/dashboard/stats');
                const data = await res.json();
                if (data.success) {
                    document.getElementById('skillsCount').textContent = data.stats.skills_count || 0;
                    document.getElementById('activeAgents').textContent = data.stats.active_agents || 0;
                    document.getElementById('llmStatus').textContent = data.stats.llm_status || 'offline';
                }
                const memRes = await fetch('http://127.0.0.1:8897/api/memory/stats');
                const memData = await memRes.json();
                if (memData.success) {
                    document.getElementById('memoryCount').textContent = memData.stats.ltm_entries || 0;
                }
            } catch (e) { console.error('Error loading stats:', e); }
        }

        function saveTelegram() {
            const botName = document.getElementById('telegramBotName').value;
            const token = document.getElementById('telegramToken').value;
            const chatId = document.getElementById('telegramChatId').value;
            
            if (!token || !chatId) {
                showToast('Token y Chat ID son requeridos', 'error');
                return;
            }
            
            currentConfig = { service: 'telegram', bot_name: botName, token, chat_id: chatId };
            pendingService = 'Telegram';
            showRestartModal();
        }

        function saveWhatsApp() {
            const accountSid = document.getElementById('waAccountSid').value;
            const authToken = document.getElementById('waAuthToken').value;
            const toNumber = document.getElementById('waToNumber').value;
            
            if (!accountSid || !authToken || !toNumber) {
                showToast('Todos los campos son requeridos', 'error');
                return;
            }
            
            currentConfig = { service: 'whatsapp', account_sid: accountSid, auth_token: authToken, to_number: toNumber };
            pendingService = 'WhatsApp';
            showRestartModal();
        }

        function deleteTelegram() {
            if (!confirm('驴Eliminar configuraci贸n de Telegram?')) return;
            document.getElementById('telegramBotName').value = '';
            document.getElementById('telegramToken').value = '';
            document.getElementById('telegramChatId').value = '';
            updateStatus('telegram', false);
            showToast('Configuraci贸n eliminada', 'success');
        }

        function deleteWhatsApp() {
            if (!confirm('驴Eliminar configuraci贸n de WhatsApp?')) return;
            document.getElementById('waAccountSid').value = '';
            document.getElementById('waAuthToken').value = '';
            document.getElementById('waToNumber').value = '';
            updateStatus('whatsapp', false);
            showToast('Configuraci贸n eliminada', 'success');
        }

        function updateStatus(service, connected) {
            const badge = document.getElementById(service + 'StatusBadge');
            const sidebarStatus = document.getElementById('sidebar-' + (service === 'telegram' ? 'tg' : 'wa') + '-status');
            
            if (connected) {
                badge.className = 'status-badge status-connected';
                badge.innerHTML = '<span class="w-2 h-2 rounded-full bg-current mr-2"></span>Conectado';
                sidebarStatus.textContent = 'Conectado';
                sidebarStatus.className = 'text-xs text-green-400';
            } else {
                badge.className = 'status-badge status-disconnected';
                badge.innerHTML = '<span class="w-2 h-2 rounded-full bg-current mr-2"></span>Desconectado';
                sidebarStatus.textContent = 'Desconectado';
                sidebarStatus.className = 'text-xs text-gray-400';
            }
        }

        function showRestartModal() {
            document.getElementById('restartService').textContent = pendingService;
            document.getElementById('restartModal').classList.remove('hidden');
        }

        function closeRestartModal() {
            document.getElementById('restartModal').classList.add('hidden');
        }

        async function confirmRestart() {
            closeRestartModal();
            showToast('Guardando y reiniciando...', 'warning');
            
            // Simulate restart
            setTimeout(() => {
                if (currentConfig.service === 'telegram') {
                    updateStatus('telegram', true);
                } else {
                    updateStatus('whatsapp', true);
                }
                showToast(pendingService + ' conectado!', 'success');
            }, 2000);
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            const colors = { info: 'bg-blue-500', success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500' };
            const icons = { info: 'fa-info-circle', success: 'fa-check-circle', error: 'fa-exclamation-circle', warning: 'fa-exclamation-triangle' };
            
            toast.className = `${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg flex items-center space-x-2 toast`;
            toast.innerHTML = `<i class="fas ${icons[type]}"></i><span>${message}</span>`;
            
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            addChatMsg('user', message);
            input.value = '';

            try {
                const provider = document.getElementById('chatApiSelector').value;
                const res = await fetch('http://127.0.0.1:8897/api/chat/send', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message, user_id: 'dashboard_user', session_id: sessionId, provider })
                });
                const data = await res.json();
                if (data.success) addChatMsg('assistant', data.response);
            } catch (e) {
                addChatMsg('assistant', 'Error: ' + e.message);
            }
        }

        function addChatMsg(role, content) {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            const bg = role === 'user' ? 'bg-cyan-600' : 'bg-white/20';
            const icon = role === 'user' ? 'fa-user' : 'fa-robot';
            
            div.innerHTML = `
                <div class="flex items-start space-x-2 max-w-[80%]">
                    ${role === 'assistant' ? `<i class="fas ${icon} mt-2 text-cyan-400"></i>` : ''}
                    <div class="${bg} px-4 py-2 rounded-xl"><p class="text-sm">${content}</p></div>
                    ${role === 'user' ? `<i class="fas ${icon} mt-2 text-gray-400"></i>` : ''}
                </div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        async function showMemoryStats() {
            try {
                const res = await fetch('http://127.0.0.1:8897/api/memory/stats');
                const data = await res.json();
                if (data.success) {
                    alert(` Memoria:\nSTM: ${data.stats.stm_sessions} sesiones\nLTM: ${data.stats.ltm_entries} entradas\nFacts: ${data.stats.facts}`);
                }
            } catch (e) { showToast('Error cargando estad铆sticas', 'error'); }
        }

        async function showSystemStatus() {
            try {
                const res = await fetch('http://127.0.0.1:8897/api/logs/system');
                const data = await res.json();
                if (data.success) {
                    alert(`ワ Sistema:\nCPU: ${data.cpu.percent.toFixed(1)}%\nMemoria: ${data.memory.percent.toFixed(1)}%\nPID: ${data.process.pid}`);
                }
            } catch (e) { showToast('Error cargando estado', 'error'); }
        }

        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        setInterval(loadStats, 30000);

        // WORKS & AUDITORIA FUNCTIONS
        let currentWorksCategory = 'all';

        async function loadWorksStats() {
            try {
                const res = await fetch('http://127.0.0.1:8897/api/works/stats/overview');
                const data = await res.json();
                
                if (data.success) {
                    const container = document.getElementById('worksCategories');
                    container.innerHTML = data.categories.map(cat => `
                        <div onclick="loadWorks('${cat.id}')" class="cursor-pointer glass-panel p-4 rounded-xl card-hover ${currentWorksCategory === cat.id ? 'ring-2 ring-blue-400' : ''}">
                            <div class="text-3xl text-center mb-2"><i class="fas ${cat.icon} text-blue-400"></i></div>
                            <div class="text-center">
                                <div class="text-2xl font-bold">${cat.count}</div>
                                <div class="text-xs text-gray-400">${cat.name}</div>
                            </div>
                        </div>
                    `).join('');
                    
                    await loadWorks(currentWorksCategory);
                }
            } catch (e) { console.error('Error cargando works stats:', e); }
        }

        async function loadWorks(category = 'all') {
            currentWorksCategory = category;
            try {
                const url = category === 'all' ? 'http://127.0.0.1:8897/api/works/list' : `http://127.0.0.1:8897/api/works/list?category=${category}`;
                const res = await fetch(url);
                const data = await res.json();
                
                const container = document.getElementById('worksList');
                const categoryNames = { 'imagenes': 'Im谩genes', 'videos': 'Videos', 'pdfs': 'PDFs', 'apps': 'Apps', 'web': 'Web', 'software': 'Software' };
                
                document.getElementById('worksCategoryTitle').textContent = category === 'all' ? 'Todos los archivos' : categoryNames[category] || category;
                
                if (data.works && data.works.length > 0) {
                    container.innerHTML = data.works.map(work => `
                        <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg hover:bg-white/10 transition">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-file text-blue-400"></i>
                                <div>
                                    <p class="font-medium text-sm">${work.original_name}</p>
                                    <p class="text-xs text-gray-400">${work.skill_name}  ${new Date(work.created_at).toLocaleString()}  ${(work.size / 1024).toFixed(1)} KB</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="downloadWork('${work.id}', '${work.original_name}')" class="px-3 py-1 bg-blue-500/20 text-blue-400 rounded-lg hover:bg-blue-500/30 transition text-sm">
                                    <i class="fas fa-download mr-1"></i>Descargar
                                </button>
                                <button onclick="deleteWork('${work.id}')" class="px-3 py-1 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30 transition text-sm">
                                    <i class="fas fa-trash mr-1"></i>
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-400">
                            <i class="fas fa-folder-open text-4xl mb-3 text-gray-600"></i>
                            <p>No hay archivos en esta categor铆a</p>
                        </div>`;
                }
                
                // Refresh categories highlight
                await loadWorksStats();
            } catch (e) { console.error('Error cargando works:', e); }
        }

        async function downloadWork(workId, filename) {
            try {
                const response = await fetch(`http://127.0.0.1:8897/api/works/${workId}/download`);
                if (!response.ok) {
                    throw new Error('Error en la descarga');
                }
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                showToast('Descargando archivo...', 'success');
            } catch (e) {
                showToast('Error al descargar: ' + e.message, 'error');
                console.error('Error descargando:', e);
            }
        }

        async function deleteWork(workId) {
            if (!confirm('驴Eliminar este archivo permanentemente?')) return;
            try {
                const res = await fetch(`http://127.0.0.1:8897/api/works/${workId}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    showToast('Archivo eliminado', 'success');
                    loadWorks(currentWorksCategory);
                }
            } catch (e) { showToast('Error eliminando archivo', 'error'); }
        }

        async function loadAuditoriaStats() {
            try {
                const res = await fetch('http://127.0.0.1:8897/api/auditoria/estadisticas');
                const data = await res.json();
                
                if (data.success) {
                    const stats = data.estadisticas;
                    document.getElementById('auditTotal').textContent = stats.total;
                    document.getElementById('auditCompleted').textContent = stats.completed;
                    document.getElementById('auditFailed').textContent = stats.failed;
                    document.getElementById('auditRunning').textContent = stats.running;
                }
            } catch (e) { console.error('Error cargando auditor铆a stats:', e); }
        }

        async function loadAuditoria() {
            try {
                const res = await fetch('http://127.0.0.1:8897/api/auditoria/registros?limit=100');
                const data = await res.json();
                
                const container = document.getElementById('auditoriaList');
                
                if (data.registros && data.registros.length > 0) {
                    container.innerHTML = data.registros.map(reg => {
                        const statusColors = { 'completed': 'text-green-400', 'failed': 'text-red-400', 'running': 'text-yellow-400' };
                        const statusIcons = { 'completed': 'fa-check-circle', 'failed': 'fa-times-circle', 'running': 'fa-spinner fa-spin' };
                        const duration = reg.duration_seconds ? `${reg.duration_seconds.toFixed(1)}s` : '...';
                        
                        return `
                        <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <i class="fas ${statusIcons[reg.status]} ${statusColors[reg.status]}"></i>
                                <div>
                                    <p class="font-medium text-sm">${reg.skill_name}</p>
                                    <p class="text-xs text-gray-400">${reg.action}  ${new Date(reg.start_time).toLocaleString()}  ${duration}</p>
                                </div>
                            </div>
                            <span class="text-xs px-2 py-1 rounded-full ${reg.status === 'completed' ? 'bg-green-500/20 text-green-400' : reg.status === 'failed' ? 'bg-red-500/20 text-red-400' : 'bg-yellow-500/20 text-yellow-400'}">
                                ${reg.status.toUpperCase()}
                            </span>
                        </div>`;
                    }).join('');
                } else {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-400">
                            <i class="fas fa-clipboard-list text-4xl mb-3 text-gray-600"></i>
                            <p>No hay registros de auditor铆a</p>
                        </div>`;
                }
                
                await loadAuditoriaStats();
            } catch (e) { console.error('Error cargando auditor铆a:', e); }
        }
    </script>
</body>
</html>
